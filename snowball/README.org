#+begin_src bash
forge build

forge fmt
#+end_src


#+begin_src bash
geth --dev --dev.period 5 --http --http.addr localhost \
    --http.port 8545 \
    --http.api 'admin,debug,web3,eth,txpool,personal,clique,miner,net' \
    --verbosity 5 --rpc.gascap 30000000  --rpc.txfeecap 0 \
    --miner.gaslimit  10 --miner.gasprice 1 --gpo.blocks 1 \
    --gpo.percentile 1 --gpo.maxprice 10 --gpo.ignoreprice 2 \
    --dev.gaslimit 30000000

cast send --from "$(cast rpc --rpc-url localhost:8545 eth_coinbase | jq -r '.')" \
    --rpc-url localhost:8545 --unlocked --value 1000000ether \
    0x85dA99c8a7C2C95964c8EfD687E95E632Fc533D6
#+end_src


#+begin_src bash
cast send --from 0x85dA99c8a7C2C95964c8EfD687E95E632Fc533D6 \
    --private-key 0x42b6e34dc21598a807dc19d7784c71b2a7a01f6480dc6f58258f78e539f1a1fa \
    --rpc-url localhost:8545 --create \
    "$(jq -r '.bytecode.object' out/Snowball.sol/Snowball.json)"

cast send --from 0x85dA99c8a7C2C95964c8EfD687E95E632Fc533D6 \
    --private-key 0x42b6e34dc21598a807dc19d7784c71b2a7a01f6480dc6f58258f78e539f1a1fa \
    -j \
    --rpc-url localhost:8545 \
    0x6FdA56C57B0Acadb96Ed5624aC500C0429d59429 \
    'function test(uint64 _seed, uint32 loops, uint256 mode) payable returns(bytes32)' \
    1 1 65519 > out.json


# Look at the OPCode Counts
cast rpc debug_traceTransaction "$(jq -r '.transactionHash' out.json)" {} | \
    jq -r '.structLogs[].op' | sort | uniq -c | sort -k1 -nr

cast rpc debug_traceTransaction "$(jq -r '.transactionHash' out.json)" {} | \
    jq -r '.structLogs[].op' | sort | uniq  > seen-opcodes.txt

# This is a coverage check to see how many opcodes we are NOT hitting with our contract
sort opcodes.txt <(sort seen-opcodes.txt opcodes.txt  | uniq -d) | uniq -u

cat out/Snowball.sol/Snowball.json  | jq '.abi' | polycli abi | sort -k3

# the first 1900 primes?
cast send --from 0x85dA99c8a7C2C95964c8EfD687E95E632Fc533D6 \
    --private-key 0x42b6e34dc21598a807dc19d7784c71b2a7a01f6480dc6f58258f78e539f1a1fa \
    --rpc-url localhost:8545 \
    -j \
    0x6FdA56C57B0Acadb96Ed5624aC500C0429d59429 \
    'function calcPrimes(uint256 ) view returns(uint256)' \
    16384 | jq '.'

# 16411
cast call --rpc-url localhost:8545 \
    0x6FdA56C57B0Acadb96Ed5624aC500C0429d59429 \
    'function primeNumbers(uint256 ) view returns(uint256)' \
    1900

#+end_src
